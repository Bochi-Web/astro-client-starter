---
/**
 * EditOverlay
 * Visual edit-mode layer activated by ?edit=true URL parameter.
 * Renders a floating toolbar, section hover highlights, and click-to-select.
 * Zero impact on the live site when inactive.
 *
 * Listens: URL ?edit=true parameter
 * Dispatches: 'section-selected' CustomEvent on window
 * Sets: data-section-selected attribute on <body>
 */
---

<!-- Edit-mode styles â€” scoped with [data-edit-mode] so they never affect the live site -->
<style is:global>
  /* â”€â”€ Toolbar â”€â”€ */
  .bw-edit-toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: rgba(15, 23, 42, 0.92);
    backdrop-filter: blur(8px);
    color: #fff;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 0.8125rem;
    line-height: 1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
  }

  .bw-edit-toolbar__label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    letter-spacing: 0.01em;
  }

  .bw-edit-toolbar__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;
    animation: bw-pulse 2s ease-in-out infinite;
  }

  @keyframes bw-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .bw-edit-toolbar__actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .bw-edit-toolbar__btn {
    padding: 0.375rem 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 0.375rem;
    background: transparent;
    color: #fff;
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .bw-edit-toolbar__btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.4);
  }

  /* Push page content down so toolbar doesn't overlap */
  [data-edit-mode] {
    padding-top: 40px;
  }

  /* â”€â”€ Section hover highlight â”€â”€ */
  [data-edit-mode] [data-section] {
    position: relative;
    cursor: pointer;
    transition: outline 0.15s ease, outline-offset 0.15s ease;
    outline: 2px dashed transparent;
    outline-offset: -2px;
  }

  [data-edit-mode] [data-section]:hover {
    outline: 2px dashed var(--color-primary, #2563eb);
  }

  /* Global sections get orange/gold dashed border */
  [data-edit-mode] [data-section][data-global="true"]:hover {
    outline-color: #f59e0b;
  }

  /* â”€â”€ Section label badge â”€â”€ */
  [data-edit-mode] [data-section]::before {
    content: attr(data-section-label);
    position: absolute;
    top: 4px;
    left: 4px;
    z-index: 100;
    padding: 0.2rem 0.5rem;
    border-radius: 0.25rem;
    background: var(--color-primary, #2563eb);
    color: #fff;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 0.6875rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    line-height: 1.4;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease;
  }

  /* Global section badges use orange/gold */
  [data-edit-mode] [data-section][data-global="true"]::before {
    background: #f59e0b;
  }

  [data-edit-mode] [data-section]:hover::before {
    opacity: 1;
  }

  /* â”€â”€ Selected state â”€â”€ */
  [data-edit-mode] [data-section].bw-section-selected {
    outline: 2px solid var(--color-primary, #2563eb);
    outline-offset: -2px;
    z-index: 51;
    position: relative;
  }

  [data-edit-mode] [data-section][data-global="true"].bw-section-selected {
    outline-color: #f59e0b;
  }

  [data-edit-mode] [data-section].bw-section-selected::before {
    opacity: 1;
  }

  /* Dim overlay behind selected section */
  .bw-edit-dimmer {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 50;
    background: rgba(0, 0, 0, 0.3);
    pointer-events: auto;
  }

  .bw-edit-dimmer.bw-active {
    display: block;
  }
</style>

<!-- Dimmer overlay (sits behind selected section) -->
<div class="bw-edit-dimmer" id="bw-edit-dimmer"></div>

<script>
  (function initEditOverlay() {
    // â”€â”€ Activation check â”€â”€
    const params = new URLSearchParams(window.location.search);
    const editFromUrl = params.get('edit') === 'true';

    // Persist across navigation via sessionStorage
    if (editFromUrl) {
      sessionStorage.setItem('bw-edit-mode', '1');
    }

    const isEditMode = editFromUrl || sessionStorage.getItem('bw-edit-mode') === '1';
    if (!isEditMode) return;

    // Ensure ?edit=true is in the URL (for sessionStorage-restored sessions)
    if (!editFromUrl) {
      const url = new URL(window.location.href);
      url.searchParams.set('edit', 'true');
      history.replaceState(null, '', url.toString());
    }

    // â”€â”€ Mark body â”€â”€
    document.body.setAttribute('data-edit-mode', 'true');

    // â”€â”€ Build toolbar â”€â”€
    const toolbar = document.createElement('div');
    toolbar.className = 'bw-edit-toolbar';
    toolbar.innerHTML = `
      <span class="bw-edit-toolbar__label">
        <span class="bw-edit-toolbar__dot"></span>
        Edit Mode â€” Bochi Web
      </span>
      <div class="bw-edit-toolbar__actions">
        <button class="bw-edit-toolbar__btn" id="bw-new-page-btn" type="button">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Page
        </button>
        <button class="bw-edit-toolbar__btn" id="bw-exit-btn" type="button">Exit Edit Mode</button>
      </div>
    `;
    document.body.prepend(toolbar);

    document.getElementById('bw-exit-btn')!.addEventListener('click', () => {
      sessionStorage.removeItem('bw-edit-mode');
      const url = new URL(window.location.href);
      url.searchParams.delete('edit');
      window.location.href = url.toString();
    });

    // â”€â”€ + New Page button â”€â”€
    document.getElementById('bw-new-page-btn')!.addEventListener('click', () => {
      deselectSection();
      window.dispatchEvent(
        new CustomEvent('section-selected', {
          detail: { section: '__new_page__', isGlobal: false },
        })
      );
    });

    // â”€â”€ Format section name: "how-it-works" â†’ "How It Works" â”€â”€
    function formatLabel(slug: string): string {
      return slug
        .split('-')
        .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }

    // â”€â”€ Label all sections â”€â”€
    const sections = document.querySelectorAll<HTMLElement>('[data-section]');
    sections.forEach((el) => {
      const name = el.getAttribute('data-section') || '';
      const isGlobal = el.getAttribute('data-global') === 'true';
      const label = isGlobal ? `ðŸŒ ${formatLabel(name)}` : formatLabel(name);
      el.setAttribute('data-section-label', label);
    });

    // â”€â”€ Selection logic â”€â”€
    const dimmer = document.getElementById('bw-edit-dimmer')!;
    let selectedSection: HTMLElement | null = null;

    function selectSection(el: HTMLElement) {
      deselectSection();
      selectedSection = el;
      el.classList.add('bw-section-selected');
      dimmer.classList.add('bw-active');

      const sectionName = el.getAttribute('data-section') || '';
      const isGlobal = el.getAttribute('data-global') === 'true';
      document.body.setAttribute('data-section-selected', sectionName);
      window.dispatchEvent(
        new CustomEvent('section-selected', {
          detail: { section: sectionName, isGlobal },
        })
      );
    }

    function deselectSection() {
      if (!selectedSection) return;
      selectedSection.classList.remove('bw-section-selected');
      selectedSection = null;
      dimmer.classList.remove('bw-active');
      document.body.removeAttribute('data-section-selected');
      window.dispatchEvent(
        new CustomEvent('section-selected', { detail: { section: null, isGlobal: false } })
      );
    }

    // Expose deselectSection globally so ChatPanel can call it
    (window as any).__bwDeselectSection = deselectSection;

    // Click on a section to select it
    sections.forEach((el) => {
      el.addEventListener('click', (e) => {
        if (selectedSection === el) return;
        e.preventDefault();
        e.stopPropagation();
        selectSection(el);
      });
    });

    // Click dimmer or press Escape to deselect
    dimmer.addEventListener('click', () => deselectSection());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') deselectSection();
    });

    // â”€â”€ Persist edit mode on internal navigation â”€â”€
    document.addEventListener('click', (e) => {
      const anchor = (e.target as HTMLElement).closest('a[href]');
      if (!anchor) return;
      const href = anchor.getAttribute('href');
      if (!href || href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('tel:')) return;

      // Internal link â€” append ?edit=true
      e.preventDefault();
      const url = new URL(href, window.location.origin);
      url.searchParams.set('edit', 'true');
      window.location.href = url.toString();
    });
  })();
</script>
