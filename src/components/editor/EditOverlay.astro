---
/**
 * EditOverlay
 * Visual edit-mode layer activated by ?edit=true URL parameter.
 * Renders a floating toolbar, section hover highlights, and click-to-select.
 * Zero impact on the live site when inactive.
 *
 * Listens: URL ?edit=true parameter
 * Dispatches: 'section-selected' CustomEvent on window
 * Sets: data-section-selected attribute on <body>
 */
---

<!-- Edit-mode styles — scoped with [data-edit-mode] so they never affect the live site -->
<style is:global>
  /* ── Toolbar ── */
  .bw-edit-toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: rgba(15, 23, 42, 0.92);
    backdrop-filter: blur(8px);
    color: #fff;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 0.8125rem;
    line-height: 1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
  }

  .bw-edit-toolbar__label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    letter-spacing: 0.01em;
  }

  .bw-edit-toolbar__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;
    animation: bw-pulse 2s ease-in-out infinite;
  }

  @keyframes bw-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .bw-edit-toolbar__exit {
    padding: 0.375rem 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 0.375rem;
    background: transparent;
    color: #fff;
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }

  .bw-edit-toolbar__exit:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.4);
  }

  /* Push page content down so toolbar doesn't overlap */
  [data-edit-mode] {
    padding-top: 40px;
  }

  /* ── Section hover highlight ── */
  [data-edit-mode] [data-section] {
    position: relative;
    cursor: pointer;
    transition: outline 0.15s ease, outline-offset 0.15s ease;
    outline: 2px dashed transparent;
    outline-offset: -2px;
  }

  [data-edit-mode] [data-section]:hover {
    outline: 2px dashed var(--color-primary, #2563eb);
  }

  /* ── Section label badge ── */
  [data-edit-mode] [data-section]::before {
    content: attr(data-section-label);
    position: absolute;
    top: 4px;
    left: 4px;
    z-index: 100;
    padding: 0.2rem 0.5rem;
    border-radius: 0.25rem;
    background: var(--color-primary, #2563eb);
    color: #fff;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 0.6875rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    line-height: 1.4;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease;
  }

  [data-edit-mode] [data-section]:hover::before {
    opacity: 1;
  }

  /* ── Selected state ── */
  [data-edit-mode] [data-section].bw-section-selected {
    outline: 2px solid var(--color-primary, #2563eb);
    outline-offset: -2px;
    z-index: 51;
    position: relative;
  }

  [data-edit-mode] [data-section].bw-section-selected::before {
    opacity: 1;
  }

  /* Dim overlay behind selected section */
  .bw-edit-dimmer {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 50;
    background: rgba(0, 0, 0, 0.3);
    pointer-events: auto;
  }

  .bw-edit-dimmer.bw-active {
    display: block;
  }
</style>

<!-- Dimmer overlay (sits behind selected section) -->
<div class="bw-edit-dimmer" id="bw-edit-dimmer"></div>

<script>
  (function initEditOverlay() {
    // ── Activation check ──
    const params = new URLSearchParams(window.location.search);
    const editFromUrl = params.get('edit') === 'true';

    // Persist across navigation via sessionStorage
    if (editFromUrl) {
      sessionStorage.setItem('bw-edit-mode', '1');
    }

    const isEditMode = editFromUrl || sessionStorage.getItem('bw-edit-mode') === '1';
    if (!isEditMode) return;

    // Ensure ?edit=true is in the URL (for sessionStorage-restored sessions)
    if (!editFromUrl) {
      const url = new URL(window.location.href);
      url.searchParams.set('edit', 'true');
      history.replaceState(null, '', url.toString());
    }

    // ── Mark body ──
    document.body.setAttribute('data-edit-mode', 'true');

    // ── Build toolbar ──
    const toolbar = document.createElement('div');
    toolbar.className = 'bw-edit-toolbar';
    toolbar.innerHTML = `
      <span class="bw-edit-toolbar__label">
        <span class="bw-edit-toolbar__dot"></span>
        Edit Mode — Bochi Web
      </span>
      <button class="bw-edit-toolbar__exit" type="button">Exit Edit Mode</button>
    `;
    document.body.prepend(toolbar);

    toolbar.querySelector('.bw-edit-toolbar__exit')!.addEventListener('click', () => {
      sessionStorage.removeItem('bw-edit-mode');
      const url = new URL(window.location.href);
      url.searchParams.delete('edit');
      window.location.href = url.toString();
    });

    // ── Format section name: "how-it-works" → "How It Works" ──
    function formatLabel(slug: string): string {
      return slug
        .split('-')
        .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }

    // ── Label all sections ──
    const sections = document.querySelectorAll<HTMLElement>('[data-section]');
    sections.forEach((el) => {
      const name = el.getAttribute('data-section') || '';
      el.setAttribute('data-section-label', formatLabel(name));
    });

    // ── Selection logic ──
    const dimmer = document.getElementById('bw-edit-dimmer')!;
    let selectedSection: HTMLElement | null = null;

    function selectSection(el: HTMLElement) {
      deselectSection();
      selectedSection = el;
      el.classList.add('bw-section-selected');
      dimmer.classList.add('bw-active');

      const sectionName = el.getAttribute('data-section') || '';
      document.body.setAttribute('data-section-selected', sectionName);
      window.dispatchEvent(
        new CustomEvent('section-selected', { detail: { section: sectionName } })
      );
    }

    function deselectSection() {
      if (!selectedSection) return;
      selectedSection.classList.remove('bw-section-selected');
      selectedSection = null;
      dimmer.classList.remove('bw-active');
      document.body.removeAttribute('data-section-selected');
      window.dispatchEvent(
        new CustomEvent('section-selected', { detail: { section: null } })
      );
    }

    // Click on a section to select it
    sections.forEach((el) => {
      el.addEventListener('click', (e) => {
        // Don't select if clicking inside an already-selected section's interactive children
        // (let the section itself handle it)
        if (selectedSection === el) return;
        e.preventDefault();
        e.stopPropagation();
        selectSection(el);
      });
    });

    // Click dimmer or press Escape to deselect
    dimmer.addEventListener('click', () => deselectSection());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') deselectSection();
    });

    // ── Persist edit mode on internal navigation ──
    document.addEventListener('click', (e) => {
      const anchor = (e.target as HTMLElement).closest('a[href]');
      if (!anchor) return;
      const href = anchor.getAttribute('href');
      if (!href || href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('tel:')) return;

      // Internal link — append ?edit=true
      e.preventDefault();
      const url = new URL(href, window.location.origin);
      url.searchParams.set('edit', 'true');
      window.location.href = url.toString();
    });
  })();
</script>
